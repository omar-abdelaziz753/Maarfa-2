import 'package:easy_localization/easy_localization.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:get/get.dart';

import '../../../bloc/pay/pay_cubit.dart';
import '../../../bloc/wallet/add_to_wallet_cubit.dart';
import '../../../model/payment_method/payment_method_model/payment_method_model.dart';
import '../../../repository/user/wallet/add_to_wallet_repository.dart';
import '../../../res/drawable/image/images.dart';
import '../../../res/value/color/color.dart';
import '../../../res/value/style/textstyles.dart';
import '../../../widget/buttons/master/master_button.dart';
import '../../../widget/buttons/master_load/master_load_button.dart';
import '../../../widget/custom_grid/custom_grid.dart';
import '../../../widget/error/page/error_page.dart';
import '../../../widget/image_handler/image_from_network/network_image.dart';
import '../../../widget/loader/loader.dart';
import '../../../widget/side_padding/side_padding.dart';
import '../../../widget/space/space.dart';
import '../../../widget/textfield/master/master_textfield.dart';
import '../course_pay/course_pay_view.dart';
import '../course_pay/lesson_pay_view.dart';


import 'package:easy_localization/easy_localization.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:get/get.dart';

import '../../../bloc/pay/pay_cubit.dart';
import '../../../bloc/wallet/add_to_wallet_cubit.dart';
import '../../../model/payment_method/payment_method_model/payment_method_model.dart';
import '../../../repository/user/wallet/add_to_wallet_repository.dart';
import '../../../res/drawable/image/images.dart';
import '../../../res/value/color/color.dart';
import '../../../res/value/style/textstyles.dart';
import '../../../widget/buttons/master/master_button.dart';
import '../../../widget/buttons/master_load/master_load_button.dart';
import '../../../widget/custom_grid/custom_grid.dart';
import '../../../widget/error/page/error_page.dart';
import '../../../widget/image_handler/image_from_network/network_image.dart';
import '../../../widget/loader/loader.dart';
import '../../../widget/side_padding/side_padding.dart';
import '../../../widget/space/space.dart';
import '../../../widget/textfield/master/master_textfield.dart';
import '../course_pay/course_pay_view.dart';
import '../course_pay/lesson_pay_view.dart';

class PaymentMethodView extends StatelessWidget {
  final bool isWallet;
  final bool isCourse;
  final int? id;
  final bool isRequest;

  const PaymentMethodView({
    super.key,
    required this.isWallet,
    required this.isCourse,
    this.id,
    this.isRequest = false,
  });

  @override
  Widget build(BuildContext context) {
    return BlocProvider(
      create: (BuildContext context) => PayCubit()..getPaymentMethod(),
      child: BlocConsumer<PayCubit, PayState>(
        listener: (context, state) {},
        builder: (context, state) {
          return BlocBuilder<PayCubit, PayState>(
            builder: (context, state) {
              if (state is PaymentMethodLoadedState) {
                final data = (state).data;
                return isWallet
                    ? _walletView(context, data)
                    : isCourse
                    ? CoursePayView(id: id!, paymentMethod: data)
                    : LessonPayView(
                    id: id!,
                    paymentMethod: data,
                    isRequest: isRequest);
              } else if (state is PayErrorState) {
                return const ErrorPage();
              } else {
                return const Loading();
              }
            },
          );
        },
      ),
    );
  }

  Widget _walletView(BuildContext context, List<PaymentMethodModel>? data) {
    return BlocProvider(
      create: (BuildContext context) => AddToWalletCubit(WalletRepository()),
      child: BlocConsumer<AddToWalletCubit, AddToWalletState>(
        listener: (context, state) {
          if (state is AddToWalletSuccessState) {
            _showSuccessDialog(context);
          } else if (state is ErrorAddToWalletState) {
            _showErrorSnackbar(context, '${state.message}');
          }
        },
        builder: (context, state) {
          final bloc = AddToWalletCubit.get(context);
          return Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [
                  Colors.grey.shade50,
                  Colors.white,
                ],
              ),
            ),
            child: SingleChildScrollView(
              physics: const BouncingScrollPhysics(),
              child: Column(
                children: [
                  _buildHeader(context),
                  _buildAmountSection(context, bloc),
                  _buildPaymentMethodsSection(context, data, bloc),
                  _buildActionButtons(context, bloc),
                  SizedBox(height: 40.h),
                ],
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildHeader(BuildContext context) {
    return Container(
      padding: EdgeInsets.symmetric(vertical: 30.h),
      child: Column(
        children: [
          // Wallet Icon with animated background
          Container(
            width: 100.w,
            height: 100.h,
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [mainColor.withOpacity(0.1), mainColor.withOpacity(0.3)],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
              shape: BoxShape.circle,
              boxShadow: [
                BoxShadow(
                  color: mainColor.withOpacity(0.3),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Center(
              child: Image.asset(
                wallet,
                height: 50.h,
                width: 50.w,
                color: mainColor,
              ),
            ),
          ),
          SizedBox(height: 20.h),
          Text(
            tr("wallet_charging"),
            style: TextStyles.headerStyle.copyWith(
              color: Colors.grey.shade800,
              fontSize: 24.sp,
              fontWeight: FontWeight.w700,
              letterSpacing: 0.5,
            ),
          ),
          SizedBox(height: 8.h),
          Text(
            tr("add_funds_to_continue"),
            style: TextStyles.subTitleStyle.copyWith(
              color: Colors.grey.shade600,
              fontSize: 14.sp,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildAmountSection(BuildContext context, AddToWalletCubit bloc) {
    return Container(
      margin: EdgeInsets.symmetric(horizontal: 20.w, vertical: 15.h),
      padding: EdgeInsets.all(20.w),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16.r),
        boxShadow: [
          BoxShadow(
            color: Colors.grey.shade200,
            blurRadius: 10,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.account_balance_wallet_outlined,
                color: mainColor,
                size: 20.sp,
              ),
              SizedBox(width: 8.w),
              Text(
                tr("amount_to_add"),
                style: TextStyles.textView16Bold.copyWith(
                  color: Colors.grey.shade800,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ],
          ),
          SizedBox(height: 15.h),
          MasterTextField(
            controller: bloc.amountController,
            keyboardType: TextInputType.number,
            hintText: tr("enter_amount"),
            prefixIcon: Container(
              padding: EdgeInsets.all(12.w),
              child: Text(
                "\$",
                style: TextStyles.textView16Bold.copyWith(
                  color: mainColor,
                  fontSize: 18.sp,
                ),
              ),
            ),
            inputFormatters: [
              FilteringTextInputFormatter.digitsOnly,
            ],
            decoration: InputDecoration(
              filled: true,
              fillColor: Colors.grey.shade50,
              border: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12.r),
                borderSide: BorderSide(color: Colors.grey.shade300),
              ),
              enabledBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12.r),
                borderSide: BorderSide(color: Colors.grey.shade300),
              ),
              focusedBorder: OutlineInputBorder(
                borderRadius: BorderRadius.circular(12.r),
                borderSide: BorderSide(color: mainColor, width: 2),
              ),
              contentPadding: EdgeInsets.symmetric(
                horizontal: 16.w,
                vertical: 16.h,
              ),
            ),
          ),
          // Quick amount buttons
          SizedBox(height: 15.h),
          _buildQuickAmountButtons(bloc),
        ],
      ),
    );
  }

  Widget _buildQuickAmountButtons(AddToWalletCubit bloc) {
    final quickAmounts = [10, 25, 50, 100];

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          tr("quick_amounts"),
          style: TextStyles.subTitleStyle.copyWith(
            color: Colors.grey.shade600,
            fontSize: 12.sp,
            fontWeight: FontWeight.w500,
          ),
        ),
        SizedBox(height: 8.h),
        Wrap(
          spacing: 8.w,
          children: quickAmounts.map((amount) {
            return GestureDetector(
              onTap: () {
                bloc.amountController.text = amount.toString();
                HapticFeedback.lightImpact();
              },
              child: Container(
                padding: EdgeInsets.symmetric(horizontal: 16.w, vertical: 8.h),
                decoration: BoxDecoration(
                  color: mainColor.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(20.r),
                  border: Border.all(color: mainColor.withOpacity(0.3)),
                ),
                child: Text(
                  "\$$amount",
                  style: TextStyles.subTitleStyle.copyWith(
                    color: mainColor,
                    fontSize: 12.sp,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            );
          }).toList(),
        ),
      ],
    );
  }

  Widget _buildPaymentMethodsSection(
      BuildContext context,
      List<PaymentMethodModel>? data,
      AddToWalletCubit bloc,
      ) {
    return Container(
      margin: EdgeInsets.symmetric(horizontal: 20.w, vertical: 10.h),
      padding: EdgeInsets.all(20.w),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16.r),
        boxShadow: [
          BoxShadow(
            color: Colors.grey.shade200,
            blurRadius: 10,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(
                Icons.payment,
                color: mainColor,
                size: 20.sp,
              ),
              SizedBox(width: 8.w),
              Text(
                tr("payment_method"),
                style: TextStyles.textView16Bold.copyWith(
                  color: Colors.grey.shade800,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ],
          ),
          SizedBox(height: 15.h),
          if (data != null && data.isNotEmpty)
            ...data.asMap().entries.map((entry) {
              final index = entry.key;
              final method = entry.value;
              final isSelected = bloc.payment == index;

              return GestureDetector(
                onTap: () {
                  bloc.setPaymentMethod(index, method.id!);
                  HapticFeedback.selectionClick();
                },
                child: AnimatedContainer(
                  duration: const Duration(milliseconds: 200),
                  margin: EdgeInsets.only(bottom: 12.h),
                  padding: EdgeInsets.all(16.w),
                  decoration: BoxDecoration(
                    color: isSelected
                        ? mainColor.withOpacity(0.1)
                        : Colors.grey.shade50,
                    borderRadius: BorderRadius.circular(12.r),
                    border: Border.all(
                      color: isSelected
                          ? mainColor
                          : Colors.grey.shade300,
                      width: isSelected ? 2 : 1,
                    ),
                  ),
                  child: Row(
                    children: [
                      // Custom radio button
                      Container(
                        width: 20.w,
                        height: 20.h,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          border: Border.all(
                            color: isSelected ? mainColor : Colors.grey.shade400,
                            width: 2,
                          ),
                          color: isSelected ? mainColor : Colors.transparent,
                        ),
                        child: isSelected
                            ? Icon(
                          Icons.check,
                          size: 12.sp,
                          color: Colors.white,
                        )
                            : null,
                      ),
                      SizedBox(width: 12.w),
                      // Payment method image
                      Container(
                        width: 45.w,
                        height: 30.h,
                        decoration: BoxDecoration(
                          color: Colors.white,
                          borderRadius: BorderRadius.circular(6.r),
                          border: Border.all(color: Colors.grey.shade200),
                        ),
                        child: ClipRRect(
                          borderRadius: BorderRadius.circular(6.r),
                          child: CachedImage(
                            imageUrl: method.image ?? "",
                            fit: BoxFit.contain,
                          ),
                        ),
                      ),
                      SizedBox(width: 12.w),
                      // Payment method name
                      Expanded(
                        child: Text(
                          Get.locale!.languageCode == "ar"
                              ? method.nameAr?.toString() ?? ""
                              : method.nameEn?.toString() ?? "",
                          style: TextStyles.textView14SemiBold.copyWith(
                            color: isSelected
                                ? mainColor
                                : Colors.grey.shade700,
                            fontWeight: isSelected
                                ? FontWeight.w600
                                : FontWeight.w500,
                          ),
                        ),
                      ),
                      if (isSelected)
                        Icon(
                          Icons.verified,
                          color: mainColor,
                          size: 18.sp,
                        ),
                    ],
                  ),
                ),
              );
            }).toList(),
        ],
      ),
    );
  }

  Widget _buildActionButtons(BuildContext context, AddToWalletCubit bloc) {
    return Container(
      margin: EdgeInsets.symmetric(horizontal: 20.w, vertical: 20.h),
      child: Row(
        children: [
          Expanded(
            flex: 2,
            child: MasterLoadButton(
              buttonHeight: 55.h,
              onPressed: () {
                if (_validateInput(context, bloc)) {
                  HapticFeedback.mediumImpact();
                  bloc.addToWallet(bloc.amountController.text.trim());
                }
              },
              buttonText: tr("confirm_payment"),
              buttonStyle: TextStyles.textView16Bold.copyWith(
                color: Colors.white,
                fontWeight: FontWeight.w600,
              ),
              buttonColor: mainColor,
              buttonController: bloc.loadController,
              borderRadius: 12.r,
            ),
          ),
          SizedBox(width: 12.w),
          Expanded(
            child: MasterButton(
              buttonHeight: 55.h,
              buttonColor: Colors.transparent,
              borderColor: Colors.grey.shade300,
              onPressed: () {
                HapticFeedback.lightImpact();
                Get.back();
              },
              buttonText: tr("cancel"),
              buttonStyle: TextStyles.textView14SemiBold.copyWith(
                color: Colors.grey.shade600,
              ),
              borderRadius: 12.r,
            ),
          ),
        ],
      ),
    );
  }

  bool _validateInput(BuildContext context, AddToWalletCubit bloc) {
    if (bloc.amountController.text.trim().isEmpty) {
      _showErrorSnackbar(context, tr("please_enter_amount"));
      return false;
    }

    final amount = double.tryParse(bloc.amountController.text.trim());
    if (amount == null || amount <= 0) {
      _showErrorSnackbar(context, tr("please_enter_valid_amount"));
      return false;
    }

    if (bloc.payment == -1) {
      _showErrorSnackbar(context, tr("please_select_payment_method"));
      return false;
    }

    return true;
  }

  void _showSuccessDialog(BuildContext context) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16.r),
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 80.w,
              height: 80.h,
              decoration: BoxDecoration(
                color: Colors.green.withOpacity(0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(
                Icons.check_circle,
                color: Colors.green,
                size: 50.sp,
              ),
            ),
            SizedBox(height: 20.h),
            Text(
              tr("payment_successful"),
              style: TextStyles.textView18Bold.copyWith(
                color: Colors.grey.shade800,
              ),
            ),
            SizedBox(height: 10.h),
            Text(
              tr("wallet_updated_successfully"),
              textAlign: TextAlign.center,
              style: TextStyles.subTitleStyle.copyWith(
                color: Colors.grey.shade600,
              ),
            ),
            SizedBox(height: 20.h),
            MasterButton(
              buttonText: tr("done"),
              onPressed: () {
                Get.back(); // Close dialog
                Get.back(); // Close payment screen
              },
              buttonColor: mainColor,
              buttonStyle: TextStyles.textView14SemiBold.copyWith(
                color: Colors.white,
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _showErrorSnackbar(BuildContext context, String message) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Row(
          children: [
            Icon(Icons.error_outline, color: Colors.white),
            SizedBox(width: 8.w),
            Expanded(child: Text(message)),
          ],
        ),
        backgroundColor: Colors.red,
        behavior: SnackBarBehavior.floating,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(8.r),
        ),
        margin: EdgeInsets.all(16.w),
      ),
    );
  }
}

// class PaymentMethodView extends StatelessWidget {
//   final bool isWallet;
//   final bool isCourse;
//   final int? id;
//   final bool isRequest;
//   const PaymentMethodView({
//     super.key,
//     required this.isWallet,
//     required this.isCourse,
//     this.id,
//     this.isRequest = false,
//   });
//
//   @override
//   Widget build(BuildContext context) {
//     return BlocProvider(
//         create: (BuildContext context) => PayCubit()..getPaymentMethod(),
//         child: BlocConsumer<PayCubit, PayState>(
//             listener: (context, state) {},
//             builder: (context, state) {
//               return BlocBuilder<PayCubit, PayState>(builder: (context, state) {
//                 if (state is PaymentMethodLoadedState) {
//                   final data = (state).data;
//                   return isWallet
//                       ? _walletView(data)
//                       : isCourse
//                           ? CoursePayView(id: id!, paymentMethod: data)
//                           : LessonPayView(
//                               id: id!,
//                               paymentMethod: data,
//                               isRequest: isRequest);
//                 } else if (state is PayErrorState) {
//                   return const ErrorPage();
//                 } else {
//                   return const Loading();
//                 }
//               });
//             }));
//   }
//
//   _walletView(List<PaymentMethodModel>? data) {
//     return BlocProvider(
//         create: (BuildContext context) => AddToWalletCubit(WalletRepository()),
//         child: BlocConsumer<AddToWalletCubit, AddToWalletState>(
//             listener: (context, state) {},
//             builder: (context, state) {
//               final bloc = AddToWalletCubit.get(context);
//               return Stack(
//                 clipBehavior: Clip.none,
//                 alignment: Alignment.topCenter,
//                 children: [
//                   SizedBox(
//                     // height: 300.h,
//                     // width: 400.w,
//                     child: Padding(
//                       padding: EdgeInsets.fromLTRB(10.w, 50.h, 10.w, 10.h),
//                       child: Column(
//                         mainAxisSize: MainAxisSize.min,
//                         children: [
//                           Text(
//                             tr("wallet_charging"),
//                             style: TextStyles.headerStyle.copyWith(
//                                 color: black,
//                                 fontSize: 20.sp,
//                                 fontWeight: FontWeight.w600),
//                           ),
//                           const SizedBox(
//                             height: 5,
//                           ),
//                           Container(
//                             margin: EdgeInsets.symmetric(
//                                 horizontal: 30.w, vertical: 20.h),
//                             child: MasterTextField(
//                               // errorText: bloc.validators[0],
//                               controller: bloc.amountController,
//                               // onChanged: (val) => bloc.validate(val),
//                               keyboardType: TextInputType.number,
//                               maxLines: 2,
//                               hintText: tr("add_to_wallet"),
//                             ),
//                           ),
//                           const Space(
//                             boxHeight: 10,
//                           ),
//                           CustomGrid(
//                             listHeight: 10000000000,
//                             count: data!.length,
//                             child: (context, index) => Row(
//                               children: [
//                                 Radio<int>(
//                                   value: index,
//                                   groupValue: bloc.payment,
//                                   onChanged: (int? v) => bloc.setPaymentMethod(
//                                       v!, data[index].id!),
//                                 ),
//                                 Opacity(
//                                     opacity: bloc.payment == index ? 1 : 0.3,
//                                     child: CachedImage(
//                                       imageUrl: data[index].image ?? "",
//                                       width: 40.w,
//                                       height: 40.h,
//                                       fit: BoxFit.contain,
//                                     )),
//                                 // Text(
//                                 //   Get.locale!.languageCode == "ar"
//                                 //       ? data[index].nameAr.toString()
//                                 //       : data[index].nameEn.toString(),
//                                 //   style: bloc.payment == index
//                                 //       ? TextStyles.textView16Bold
//                                 //           .copyWith(color: mainColor)
//                                 //       : TextStyles.subTitleStyle.copyWith(
//                                 //           fontWeight: FontWeight.w700,
//                                 //           color: grey),
//                                 // ),
//                               ],
//                             ),
//                           ),
//                           const Space(
//                             boxHeight: 10,
//                           ),
//                           SidePadding(
//                             sidePadding: 30,
//                             child: Row(
//                               mainAxisAlignment: MainAxisAlignment.spaceBetween,
//                               children: [
//                                 Expanded(
//                                   child: MasterLoadButton(
//                                     buttonHeight: 55,
//                                     onPressed: () => bloc.addToWallet(
//                                         bloc.amountController.text.trim()),
//                                     // context: context,
//                                     // wallet: true,
//                                     // amount: bloc.amount.text.trim()),
//                                     buttonText: tr("confirm"),
//                                     buttonStyle: TextStyles.textView14SemiBold
//                                         .copyWith(color: white),
//                                     buttonColor: mainColor,
//                                     buttonController: bloc.loadController,
//                                   ),
//                                 ),
//                                 const Space(
//                                   boxWidth: 10,
//                                 ),
//                                 Expanded(
//                                   child: MasterButton(
//                                     buttonHeight: 55,
//                                     buttonColor: profileColor,
//                                     borderColor: profileColor,
//                                     onPressed: () {
//                                       Get.back();
//                                     },
//                                     buttonText: tr("cancel"),
//                                     buttonStyle: TextStyles.textView14SemiBold
//                                         .copyWith(color: mainColor),
//                                   ),
//                                 ),
//                               ],
//                             ),
//                           ),
//                           const Space(
//                             boxHeight: 30,
//                           ),
//                         ],
//                       ),
//                     ),
//                   ),
//                   Positioned(
//                       top: -50,
//                       child: Image.asset(wallet,
//                           height: 100, width: 100, fit: BoxFit.cover)),
//                 ],
//               );
//             }));
//   }
// }
